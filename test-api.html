<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API 키 테스트</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 600px; margin: 0 auto; }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; }
        button { background: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #2563eb; }
        .result { margin-top: 20px; padding: 15px; border-radius: 4px; }
        .success { background: #d1fae5; border: 1px solid #10b981; color: #065f46; }
        .error { background: #fee2e2; border: 1px solid #ef4444; color: #991b1b; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔑 Gemini API 키 테스트</h1>
        <p>Google AI Studio에서 발급받은 Gemini API 키를 입력하여 연결을 테스트하세요.</p>
        
        <input type="password" id="apiKey" placeholder="API 키를 입력하세요 (AI로 시작하는 긴 문자열)">
        <button onclick="testConnection()">연결 테스트</button>
        
        <div id="result"></div>
        
        <h2>📋 사용법</h2>
        <ol>
            <li><a href="https://aistudio.google.com/" target="_blank">Google AI Studio</a>에서 API 키를 발급받으세요</li>
            <li>위 입력 필드에 API 키를 붙여넣으세요</li>
            <li>"연결 테스트" 버튼을 클릭하세요</li>
            <li>성공하면 메인 앱에서 같은 API 키를 사용할 수 있습니다</li>
        </ol>
        
        <h2>🔗 메인 앱으로 이동</h2>
        <p><a href="index.html">AI ClassNote</a>로 이동하여 실제 기능을 사용해보세요.</p>
    </div>

    <script>
        async function testConnection() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const resultDiv = document.getElementById('result');
            
            if (!apiKey) {
                showResult('API 키를 입력해주세요.', 'error');
                return;
            }
            
            if (!apiKey.startsWith('AI')) {
                showResult('올바른 Gemini API 키 형식이 아닙니다. API 키는 "AI"로 시작해야 합니다.', 'error');
                return;
            }
            
            showResult('연결 테스트 중...', 'info');
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: "안녕하세요. 연결 테스트입니다. 간단한 응답을 해주세요."
                            }]
                        }]
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                        const responseText = data.candidates[0].content.parts[0].text;
                        showResult(`✅ 연결 성공!<br><br>AI 응답: "${responseText}"<br><br>이제 메인 앱에서 이 API 키를 사용할 수 있습니다.`, 'success');
                        
                        // 세션 스토리지에 API 키 저장
                        sessionStorage.setItem('gemini_api_key', apiKey);
                    } else {
                        showResult('❌ API 응답 형식이 올바르지 않습니다.', 'error');
                    }
                } else {
                    const errorData = await response.json();
                    let errorMessage = `❌ 연결 실패 (${response.status})`;
                    
                    if (errorData.error) {
                        switch (errorData.error.code) {
                            case 400:
                                errorMessage += '<br>API 키가 유효하지 않습니다.';
                                break;
                            case 403:
                                errorMessage += '<br>API 접근 권한이 없습니다.';
                                break;
                            case 429:
                                errorMessage += '<br>API 사용량이 초과되었습니다.';
                                break;
                            default:
                                errorMessage += `<br>${errorData.error.message || '알 수 없는 오류'}`;
                        }
                    }
                    
                    showResult(errorMessage, 'error');
                }
            } catch (error) {
                showResult(`❌ 네트워크 오류: ${error.message}`, 'error');
            }
        }
        
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = message;
            resultDiv.className = `result ${type}`;
        }
        
        // 페이지 로드 시 저장된 API 키 복원
        window.addEventListener('load', () => {
            const savedKey = sessionStorage.getItem('gemini_api_key');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
            }
        });
    </script>
</body>
</html>
